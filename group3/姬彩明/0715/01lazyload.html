<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <meta name="referrer" content="no-referrer" />
      <title>Document</title>
</head>
<body>
      <div class="container">
            <img src="" alt="">
      </div>
      <script src="../../libs/common.js"></script>

      <script>
            let {ajax , $ , on} = Utils;      
            class Render{
                  constructor(){
                        this.init();
                  }
                  async init(){
                      this.load_url = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563172097821&di=5a91819ee43850fc70b858e143165238&imgtype=0&src=http%3A%2F%2Fimg4q.duitang.com%2Fuploads%2Fitem%2F201505%2F23%2F20150523090235_fJUxr.gif"
                      this.container = $(".container");
                      this.cHeight = document.documentElement.clientHeight;
                      // 添加卷动事件;

                      this.timer = null;
                      on(window , "scroll" , ()=>{
                        if(this.timer != null)  return false;
                        this.timer = setTimeout ( ()=>{
                              this.imgShow();
                              this.timer = null;
                        },500)    
                      })
                      let res = await this.loadData();
                      this.render(res.data.object_list);
                      this.getAllimg();
                  }
                  async loadData(){
                        let url = "http://localhost/dt";
                        let data = {
                              include_fields:"top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                              filter_id: "美食菜谱",
                              start : 0
                        };
                        let res = await ajax(url,{data : data,dataType : "json"});

                        return res;
                  }
                  render(list){
                        // console.log(list);
                        let html = "";
                        list.forEach( item => {
                              html += `   <div class="box" data-img=${item.photo.path}
                                                >
                                                <img src="${this.load_url}" style="width:400px;height:${400/item.photo.width * item.photo.height}px;" 
                                                alt="">
                                          </div>
                                       `
                        })
                        this.container.innerHTML = html;
                  }
                  getAllimg(){
                        this.imgs = Array.from(this.container.children);
                        // console.log(imgs);
                       this.imgs.forEach( img => {
                              img.setAttribute("data-top", img.offsetTop);
                        })
                  }
                  imgShow(){
                        let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
                        this.imgs.forEach( img => {
                              let img_top = img.getAttribute("data-top");
                              if(scrollTop + this.cHeight >= img_top - 300){
                                    // console.log(img);
                                    let src = img.getAttribute("data-img");
                                    img.children[0].src = src;
                              }
                        });
                  }     
            }
            new Render();

            // JS专门给IMG提供了一个构造函数;
            // let img = new Image();
            // // let img2 = document.createElement("img");
            // // console.log(img,img2);
            // // console.dir(img);
            // img.src = "https://c-ssl.duitang.com/uploads/item/201905/30/20190530074604_kjiuw.png";
            // // img存在一个特征 , 只要设置了src不用放入浏览器就可以发起一个请求。
           
            // img.onload = function(){
            //       document.body.appendChild(img);
            //       console.log(img.width , img.height);
            // }
            //1080 1053
            
            // let img = $(".container img");
            // img.src = "";
            
            // let loadImg = new Image();
            // loadImg.src = "https://c-ssl.duitang.com/uploads/item/201905/30/20190530074604_kjiuw.png";
            // loadImg.onload = function(){
            //       img.src = "https://c-ssl.duitang.com/uploads/item/201905/30/20190530074604_kjiuw.png";
            // }


      </script>
</body>
</html>