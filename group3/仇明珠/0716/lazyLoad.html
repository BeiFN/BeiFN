<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <!-- <img src="" alt=""> -->
    </div>
    <script src="../libs/ejs.js"></script>
    <script src="../libs/utils.js"></script>
    <script>
        let { ajax, $ ,on} = Utils;
        class Render {
            constructor() {
                this.init();
            }
            async init() {
                this.loadingUrl="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563172097821&di=5a91819ee43850fc70b858e143165238&imgtype=0&src=http%3A%2F%2Fimg4q.duitang.com%2Fuploads%2Fitem%2F201505%2F23%2F20150523090235_fJUxr.gif";
                this.container = $(".container");
                this.cHeight=document.documentElement.clientHeight;
                let timer=null;
                on(document,"scroll",()=>{
                    if(timer!=null) return false;
                    timer=setTimeout(()=>{
                        this.showImg();
                        timer=null;
                    },500)
                })
                this.data = await this.loadData(0);
                this.renderImg();
                this.getImg();
            }
            async loadData(start) {
                let url = "http://localhost/dt";
                let data = {
                    include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                    filter_id: "美食菜谱",
                    start: start
                };
                let res=await ajax(url,{data:data,dataType:"json"});
                return res.data.object_list;
            }
            renderImg(){
                let html="";
                for(let i=0;i<this.data.length;i++){
                    html+=`
                        <div class="box" data-img="${this.data[i].photo.path}">
                            <img src="${this.loadingUrl}" alt="" style="width:400px;height:${400/this.data[i].photo.width*this.data[i].photo.height}px">
                        </div>
                         `
                }
                this.container.innerHTML=html;
            }
            getImg(){
                this.imgList=Array.from(this.container.children);
                this.imgList.forEach((item)=>{
                    item.setAttribute("data-top",item.offsetTop);
                })
            }
            showImg(){
                let scrollTop=document.documentElement.scrollTop||document.body.scrollTop;
                this.imgList.forEach((item)=>{
                    if(scrollTop+this.cHeight>=item.getAttribute("data-top")){
                        item.children[0].src=item.getAttribute("data-img");
                    }
                })
            }
        }
        new Render();
    </script>
</body>

</html>