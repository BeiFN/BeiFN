<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <meta name="referrer" content="no-referrer" />
      <title>Document</title>
</head>

<body>
      <div class="container">

      </div>
      <script src="../libs/common.js"></script>
      <script src="../libs/jquery.js"></script>
      <script>
            // let { ajax: myAJAX, $: $$, on } = Utils;
            // class Render {
            //       constructor() {
            //             this.init();
            //       }
            //       async init() {
            //             this.load_url = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563172097821&di=5a91819ee43850fc70b858e143165238&imgtype=0&src=http%3A%2F%2Fimg4q.duitang.com%2Fuploads%2Fitem%2F201505%2F23%2F20150523090235_fJUxr.gif";
            //             this.container = $$(".container");
            //             this.cHeight = document.documentElement.clientHeight;
            //             // 添加卷动事件显示图片;
            //             this.timer = null;
            //             on(window, "scroll", () => {
            //                   if (this.timer != null) return false;
            //                   this.timer = setTimeout(() => {
            //                         // console.log(1);
            //                         this.imgShow();
            //                         this.timer = null;
            //                   }, 500);
            //             });
            //             let res = await this.loadData();
            //             this.render(res.data.object_list);
            //             this.getAllImgTop();
            //             this.imgShow();
            //       }
            //       async loadData() {
            //             let url = "http://localhost/dt";
            //             let data = {
            //                   include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
            //                   filter_id: "美食菜谱",
            //                   start: 0
            //             };
            //             // let res = await myAJAX({ url: url, data: data, data_type: "json" });
            //             let res = await $.ajax({ url: url, data: data, data_type: "json" });
            //             // console.log(res);
            //             return res;
            //       }
            //       render(list) {
            //             // console.log(list);
            //             let html = "";
            //             list.forEach(item => {
            //                   html += `<div class="box" data-img=${item.photo.path}>
            //                               <img src="${this.load_url}" style="width:400px;height:${400 / item.photo.width * item.photo.height}px;"alt="">
            //                            </div>`;
            //             });
            //             this.container.innerHTML += html;
            //       }
            //       getAllImgTop() {
            //             this.imgs = Array.from(this.container.children);
            //             // console.log(imgs);
            //             this.imgs.forEach(img => {
            //                   img.setAttribute("data-top", img.offsetTop);
            //             });
            //       }
            //       imgShow() {
            //             let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
            //             this.imgs.forEach(img => {
            //                   let img_top = img.getAttribute("data-top");
            //                   if (scrollTop + this.cHeight >= img_top - 300) {
            //                         // console.log(img);
            //                         let src = img.getAttribute("data-img");
            //                         img.children[0].src = src;
            //                   }
            //             });
            //       }
            // }
            // let render = new Render();

            function Render() {
                  this.init();
            }
            $.extend(Render.prototype, {
                  init: function () {
                        this.load_url = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563172097821&di=5a91819ee43850fc70b858e143165238&imgtype=0&src=http%3A%2F%2Fimg4q.duitang.com%2Fuploads%2Fitem%2F201505%2F23%2F20150523090235_fJUxr.gif";
                        this.container = $(".container");
                        this.cHeight = document.documentElement.clientHeight;
                        // 添加卷动事件显示图片;
                        this.timer = null;
                        $(window).on("scroll", $.proxy(function () {
                              if (this.timer != null) return false;
                              this.timer = setTimeout($.proxy(function () {
                                    // console.log(1);
                                    this.imgShow();
                                    this.timer = null;
                              }, this), 500);
                        }, this));
                        this.loadData().then($.proxy(function (res) {
                              // console.log(res);
                              this.render(res.data.object_list);
                              this.getAllImgTop();
                              this.imgShow();
                        }, this));
                  },
                  loadData: function () {
                        var url = "http://localhost/dt";
                        var data = {
                              include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                              filter_id: "美食菜谱",
                              start: 0
                        };
                        // let res = await myAJAX({ url: url, data: data, data_type: "json" });
                        return $.ajax({ url: url, data: data, data_type: "json" });
                  },
                  render: function (list) {
                        // console.log(list);
                        // console.log(this);
                        var html = "";
                        list.forEach($.proxy(function (item) {
                              html += `<div class="box" data-img=${item.photo.path}>
                                           <img src="${this.load_url}" style="width:400px;height:${400 / item.photo.width * item.photo.height}px;"alt="">
                                        </div>`;
                        },this));
                        // console.log(html);
                        this.container.html(html);
                  },
                  getAllImgTop: function () {
                        // console.log(this.container);
                        this.imgs = Array.from(this.container.children());
                        // console.log(this.imgs);
                        this.imgs.forEach(function (img) {
                              // console.log(img);
                              $(img).attr("data-top", img.offsetTop);
                        });
                  },
                  imgShow: function () {
                        var scrollTop = $("html,body").scrollTop();
                        this.imgs.forEach($.proxy(function (img) {
                              var img_top = $(img).attr("data-top");
                              if (scrollTop + this.cHeight >= img_top - 300) {
                                    // console.log(img);
                                    var src = $(img).attr("data-img");
                                    // console.log(src);
                                    img.children[0].src = src;
                              }
                        },this));
                  }
            });
            let render = new Render();
      </script>
</body>

</html>