<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div class ="container">
        <img src = "" alt="">
    </div>
    <script src="libs/utils.js"></script>
    <script>
        let {ajax , $ , on} = Utils;
        class Render{
            constructor(){
                this.init();
            }
            async init(){
                this.load_url  = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563172097821&di=5a91819ee43850fc70b858e143165238&imgtype=0&src=http%3A%2F%2Fimg4q.duitang.com%2Fuploads%2Fitem%2F201505%2F23%2F20150523090235_fJUxr.gif";
                this.container = $(".container");
                this.cHeight   = document.documentElement.clientHeight;

                //添加滚动事件
                this.timer = null;
                on(window , "scroll" , () => {
                    if(this.timer != null){
                        return false;
                    }
                    this.timer = setTimeout ( ()=> {
                        this.imgShow();
                        this.timer = null;
                    } , 500)
                }) 
                let res = await this.loadData();
                this.render(res.data.object_list);
                this.getAllimg();
            }
            //加载数据
            async loadData(){
                let url = "http://localhost/dt";
                let data = {
                    include_fields:"top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                    filter_id: "美食菜谱",
                    start : 0
                };
                let res = await ajax(url,{data : data,dataType : "json"});
                return res;
            }
            //渲染
            render(list){
                let html = "";
                list.forEach( item => {
                    html += `<div class="box" data-img=${item.photo.path}>
                                <img src="${this.load_url}" style="width:400px;height:${400/item.photo.width * item.photo.height}px;" alt="">
                            </div>`
                })
                this.container.innerHTML = html;
            }
            getAllimg(){
                this.imgs = Array.from(this.container.children);
                this.imgs.forEach(img => {
                    img.setAttribute("data-top" , img.offsetTop);
                })
            }
            //根据scroll计算显示图片
            imgShow(){
                let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
                this.imgs.forEach( img => {
                    let img_top = img.getAttribute("data-top");
                    if(scrollTop + this.cHeight >= img_top - 3000){
                        let src = img.getAttribute("data-img");
                        img.children[0].src = src;
                    }
                });
            }
        }
        new Render();
    </script>
</body>
</html>