<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <form id="form">
        <p>用户名 : <input type="text" name="username" value="yanghuaizhi"></p>
        <p>密  码 : <input type="text" name="password" value="123456"></p>
        <button id="btn">提交</button>
  </form>
  <script src="utils.js"></script>
  <script>
      let {ajax , $} = Utils;
      let[form , btn ] = [
          $("#form"),
          $("#btn")
      ];
      form.addEventListener("submit" , evt => {
          let e = evt || window.event;
          e.preventDefault();
      })
      btn.addEventListener("click" , evt => {
          let[
              userValue ,
              pwdValue
          ] = [
              $("input[name=username]").value,
              $("input[name=password]").value,
          ]
          //禁用按钮
          btn.disabled = "disabled";
          btn.innerHTML = "loading...";
          let url = "http://localhost/GP12/0712/login.php";
          let data = {
              username : userValue,
              password : pwdValue
          }

          ajax(url , {
              data ,
              type : "POST",
              dataType : "json"
          })
          .then(res => {
              switch(res.stateCode){
                  case 0 :
                        pwdValuealert("登陆参数不全");
                        break;
                  case 1 :
                        pwdValuealert("登陆成功");
                        location.reload();
                        break;
                  case 2 :
                        pwdValuealert("数据库连接失败");
                        break; 
                  case 3 :
                        pwdValuealert("用户名不存在");
                        break;
                  case 4 :
                        pwdValuealert("密码错误");
                        break;             
              }
              btn.removeAttribute("disabled");
              btn.innerHTML ="登陆";

              console.log(res);
          })
      })
      //先发一个请求。验证是否存在tocken，如果存在就不用登录了，如果不存在继续去登陆；
      function validateTocken(){
          let url = "http://localhost/GP12/0712/login.php";
          ajax(url)
          .then( res => {
              res = JSON.parse(res)
              if(res.state){
                  return false;
              }
              form.innerHTML = "用户名为：" + res.username + "<button id = 'exit'>退出登录</button>";
          })

      }
      validateTocken();
  </script>
</body>
</html>