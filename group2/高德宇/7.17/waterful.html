<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="referrer" content="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        h1 {
            text-align: center;
        }
        
        .container {
            width: 1000px;
            /* -- 行内样式 -- */
            line-height: 1.5;
            zoom: 1;
            overflow: hidden;
            /* visibility: hidden; */
            margin-left: auto;
            margin-right: auto;
        }
        
        .wrapper {
            height: auto;
            border-top: 0 none;
            background-color: #fff;
            border-radius: 2px;
            position: relative;
        }
        
        .box {
            border-bottom: 1px solid #e0e0e0;
            width: 235px;
            padding: 0;
            border-radius: 2px 2px 0 0;
            float: left;
            margin-left: 15px;
            box-sizing: border-box;
        }
        
        .box-img {
            height: 264px;
            /* 行内样式*/
            position: relative;
            min-height: 100px;
        }
        
        .box-img img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            max-width: 235px;
        }
        
        .box-img u {
            height: 264px;
            /* 行内样式 */
            position: absolute;
            top: 0;
            left: 0;
            width: 235px;
            min-height: 100px;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            margin-top: 0!important;
            border: 1px solid #e0e0e0;
        }
        
        .box-detail {
            padding: 14px 0;
            border-width: 0 1px 0 1px;
            border-style: solid;
            border-color: #e0e0e0;
        }
        
        .box-detail .title {
            padding: 0 14px;
            clear: both;
            overflow: hidden;
            margin: 0;
            font-size: 14px;
            color: #444;
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
    <title>Document</title>
</head>

<body>
    <h1>瀑布流</h1>
    <div class="container">
        <div class="wrapper">

        </div>
    </div>
    <script src="../../jquery.js"></script>
    <script src="../../libs/utils.js"></script>
    <script>
        let {
            on
        } = Utils;
        class Waterfoll {
            constructor() {

                this.init();
            }
            async init() {
                this.container = $('.container')[0];
                console.log(this.container)
                this.wrapper = $('.wrapper')[0];
                // 第一排能放下多少个元素;
                this.count = 0;
                this.heightArray = [];
                this.changeContainerWidth();
                let timer = null;
                on(window, "resize", () => {
                    clearTimeout(timer);
                    timer = setTimeout(() => {
                        this.changeContainerWidth();
                        timer = null;
                    }, 500)
                })
                let res = await new Load().init(0);
                this.render(res);
                this.sort();
            }
            changeContainerWidth() {
                let cWidth = document.documentElement.clientWidth;
                this.count = parseInt(cWidth / 250);
                this.container.style.width = this.count * 250 + "px";
            }
            render(list) {
                let html = "";
                for (var i = 0; i < list.length; i++) {
                    let scaleHeight = parseInt(235 / list[i].photo.width * list[i].photo.height);
                    html += `<div class="box">
                              <div class="box-img" style="height:${scaleHeight}px">
                                    <img src="${list[i].photo.path}" alt="">
                                    <u style="height:${scaleHeight}px"></u>
                              </div>
                              <div class="box-detail">
                                    <div class="title">
                                          ${list[i].msg}
                                    </div>
                              </div>
                        </div>`
                }

                this.wrapper.innerHTML = html;
            }

            sort() {
                // 区分 ;
                // 1. 第一排的;
                // 2. 其余的;
                let children = this.wrapper.children;
                // console.log(children);
                Array.from(children).forEach((box, index) => {
                    if (index < this.count) {
                        // console.log("第一排" , box);
                        this.heightArray.push(box.offsetHeight);
                    } else {
                        // 找到数组之中最小的那一个;
                        let min = Math.min.apply(false, this.heightArray);
                        let minIndex = this.heightArray.indexOf(min);
                        // console.log(min , minIndex)
                        box.style.position = "absolute";
                        box.style.left = minIndex * 250 + "px";
                        box.style.top = min + 20 + "px";

                        this.heightArray[minIndex] += box.offsetHeight + 20;
                    }
                })

                let maxHeight = Math.max.apply(false, this.heightArray);

                this.container.style.height = maxHeight + "px";
                console.log(this.heightArray);
            }
        }
        class Load {
            constructor() {}
            async init(start) {
                let url = "http://localhost/dt";
                let data = {
                    include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                    filter_id: "美食菜谱",
                    start: start
                };
                let res = await $.ajax(url, {
                    data: data,
                    dataType: "json",
                }).done(function(res) {
                    console.log(res);
                    return res;

                });
                console.log(res.data.object_list)
                return res.data.object_list;

            }
        }

        new Waterfoll();
    </script>
</body>

</html>