<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    
</body>
<script>
    class Utils{
        static ajax(
            url,
            {
                data,
                datatype,
                type,
                callback
            }={
                data:{},
                datatype:"text",
                type:"get",
                callback :"callback"
            }
        ){
            //如果datatype为jsonp，直接调用Utiles.jsonp
            if(datatype === "jsonp"){
                return Utils.jsonp(url, data, callback);
            }
            return new Promise(function(resolve, reject){
                let xhr = null;
                
                if(XMLHttpRequest){
                    xhr = new XMLHttpRequest;
                }else{
                    xhr = new ActiveXObject("Mricosoft.XMLHTTP");
                }
                if(xhr == null) throw console.error("浏览器不支持ajax");
                
                //当data中的数据变为这种参数形式：data1=1&data2=2
                let data_Str = "";
                for(let attr in data){
                    data_Str += (data_Str.length>0 ? "&" : "?") + attr + "=" + data[attr];
                }

                //如果是type===get，需要在地址后面加上参数
                type === "get" ? url += (/\?/.test(url) ? "&" : "?") + data_Str : "";

                xhr.open(type, url);

                //如果是type===post，需要给xhr添加一个请求头参数，同时在send中传入数据
                type === "post" ? xhr.setRequsetHeader("content-type", "application/x-www-form-urlencoded"): null;
                xhr.send(type==="post"? data_Str : null);
                //事件监听
                xhr.onreadystatechange = function(){
                    if(xhr.readyState===4 && xhr.status===200){
                        let res = xhr.responseText; 
                        console.log(res);
                        switch(datatype){
                            case "text" : typeof res === "string" ? res :JSON.stringify(res);
                                         break;
                            case "json" : typeof res === "string" ? JSON.parse(res) : res;
                        }
                        
                        resolve(res);
                    }
                }
            })
        }

        static jsonp(url,data,callback = "callback"){
            return new Promise(function(resolve, reject){
                let GLOBAL_name = "_" + Date.now();
                window[GLOBAL_name] = function(res){
                    resolve(res);
                    delete window[GLOBAL_name];
                    GLOBAL_name = false;
                }
                if(typeof data == "object"){
                    for(let attr in data){
                        url += (/\?/.test(url) ? "&": "?") + attr + "=" +data[attr];
                    }
                }
                url += "&" + callback + "=" +GLOBAL_name;
                let _script = document.createElement("script");
                _script.src = url;
                _script.onload = function(){
                    this.remove();
                }
                document.body.appendChild(_script);

            })    
        }      
    }

    let {ajax} = Utils;
    var url = "http://localhost:8888/gp12-js-php/js_test/0710/products.json";
    ajax(url , { datatype : "json"})
    .then( res => {
            console.log(res);
    })
</script>
</html>