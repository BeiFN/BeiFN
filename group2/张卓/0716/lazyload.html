<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="referrer" content="no-referrer" />
    <title>Document</title>
</head>

<body>
    <div class="container">
        <img src="" alt="">
    </div>
    <script src="../libs/utils.js"></script>
    <script>
        let { $, ajax,on } = Utils;
        class Rander {
            constructor() {
                this.init();
            }
            async init() {
                this.load_url = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563172097821&di=5a91819ee43850fc70b858e143165238&imgtype=0&src=http%3A%2F%2Fimg4q.duitang.com%2Fuploads%2Fitem%2F201505%2F23%2F20150523090235_fJUxr.gif"
                //获取数据
                this.res = await this.load();
                this.container = $(".container")
                //获取页面的高度
                this.cHeight = document.documentElement.clientHeight;
                //渲染
                this.render();
                //设置高度
                this.setHeight();
                //当页面滚动触发的
                let timer = null;
                on(window,"scroll",()=>{
                    //使用节流的方式
                    if(!timer){
                        timer = setTimeout(()=>{
                            timer = null;
                            this.loadImg()
                        },500)
                    }
                })
            }

            async load() {
                let url = "http://localhost/dt";
                let data = {
                    include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                    filter_id: "手工DIY",
                    //start是开始的下标
                    start: 0
                };
                let res = await ajax(url, { data: data, dataType: "json" });
                return res.data.object_list
            }
            render() {
                let html = ""
                this.res.forEach(item=>{
                    html += `<div class="box" data-img=${item.photo.path}>
                                <img src="${this.load_url}" style="width:400px;height:${400 / item.photo.width * item.photo.height}px;" 
                                 alt="">
                              </div>`
                })
                this.container.innerHTML = html
            }
            setHeight(){
                this.imgList =Array.from(this.container.children);
                this.imgList.forEach(img=>{
                    console.log(img.offsetTop)
                    img.setAttribute("data-top",img.offsetTop);
                })
            }
            //加载原图片
            loadImg(){
                let scrollTop = document.documentElement.scrollTop||document.body.scrollTop;
                this.imgList.forEach(item=>{
                    if(scrollTop+this.cHeight>item.getAttribute("data-top")-300){
                        let url = item.getAttribute("data-img")
                        item.children[0].src = url
                    }
                })
            }


        }
        new Rander();
    </script>
</body>

</html>