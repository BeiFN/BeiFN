<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="referrer" content="no-referrer" />
    <title>Document</title>
</head>

<body>
    <div class="container">
        <!-- <img src="" alt=""> -->
    </div>
    <script src="../utils.js"></script>

    <script>
        let { $, on, ajax } = Utils;
        class Dt {
            constructor() {
                this.init();
            }
            async init() {
                this.load_url = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563210652727&di=702493a015f946a456740f2fcb3ec1b6&imgtype=0&src=http%3A%2F%2Fimg.zcool.cn%2Fcommunity%2F01af1f568cd3796ac725bb5c8fdd8e.gif";
                this.container = $(".container");
                let timer = null;
                this.cHeight = document.documentElement.clientHeight;
                let res = (await new LoadData().init()).data.object_list;
                this.render(res);
                this.allImg();
                on(window,"scroll",()=>{
                    if(timer != null) return false;
                    timer = setTimeout(()=>{
                        this.showImg();
                        timer = null;
                    },500)
                })
            }
            render(list) {
                let html = "";
                for (var i = 0, item; item = list[i]; i++) {
                    html+=`
                        <div class="container" data-img="${item.photo.path}">
                            <img src="${this.load_url}" style="width:235px;height:${parseInt(235/item.photo.width*item.photo.height)}px;margin-top:20px;" alt="">
                        </div>
                    `
                }
                this.container.innerHTML = html;
            }

            allImg(){
                this.imgs =Array.from(this.container.children);
                this.imgs.forEach(item=>{
                    item.setAttribute("data-top",item.offsetTop);
                })
            }



            showImg(){
                let scrollTop = document.documentElement.scrollTop;
                this.imgs.forEach(item=>{
                    if(item.getAttribute("data-top")<=scrollTop+this.cHeight){
                        let url = item.getAttribute("data-img");
                        item.children[0].src=url;
                    }
                })
            }





        }








        class LoadData {
            constructor() {

            }
            async init(start) {
                let url = "http://localhost/dt";
                let data = {
                    include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                    filter_id: "搞笑萌宠",
                    start: start,
                    _: 1563094065180
                }
                let res = await ajax(url, {
                    data,
                    dataType: "json"
                });
                return res
            }
        }
        new Dt();
    </script>
</body>

</html>