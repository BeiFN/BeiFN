<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>jsonp练习</title>
</head>
<body>
    <script>
            //直接在本页面进行跳转 不是用localhost
            // function foo(res){
            //     console.log(res);
            // }
            // function callback(res){
            //     console.log(res);
            // }

            // document.onclick = function(){
            //     var script = document.createElement("script");
            //     script.src = "http://localhost/js/test/0711/jsontest.php";

            //     document.body.appendChild(script);
            // }

            // document.onclick = function(){
            //     var script = document.createElement("script");
            //     script.src = "http://localhost/js/test/0711/jsontest.php";
            //     //表示请求发生完毕
            //     script.onload = function(){
            //         //最好用this
            //         this.remove();
            //     }
            //     document.body.appendChild(script);
            // }

            //---------------问题2不想使用全局函数了 一切尽在掌握之中
            //后台的函数名是由前端发送并解决的  callback=ssss
            // function ssss(res){
            //     console.log(res);
            // }
            // document.onclick = function(){
            //     var script = document.createElement("script");
            //     script.src = "http://localhost/js/test/0711/jsontest.php?callback=ssss";
            //     script.onload = function(){
            //         this.remove();
            //     }
            //     document.body.appendChild(script);
            // }  

            //----------------------封装---------------
            //问题3 想要封装    
            //在函数内声明全局函数
            // function jsonp(){
            //     window.sss = function(){

            //     }
            // }
            
            // jsonp();
            // //在函数内声明的全局函数必须等他父函数执行，才可以被访问到
            // console.log(sss);
                //callback=ssss
            // function jsonp(url,cb_fild,callback){
            //     var GLOBAL_CB = "foo";
            //     //全局函数
            //     window[GLOBAL_CB] = function(res){
            //         callback(res);
            //     }
            //     //发送请求
            //     var script = document.createElement("script");
            //     url += /\?/.test(url) ? "&" : "?";
            //     //拼接url 和传入的函数名
            //     script.src = url + cb_fild + "=" + GLOBAL_CB;

            //     script.onload = function(){
            //         this.remove();
            //     }
            //     document.body.appendChild(script);
            // }
            // //这里的res是由后台返回的
            // jsonp("http://localhost/js/test/0711/jsontest.php","callback",function(res){
            //     console.log(res);
            // })
            
            //一回生二回熟
            //马力八字
            //可算是弄出来了 hiahiahi啊哈
            // function jsonp(url,cb_fild){
                    
            //     return new Promise(function(resolve,reject){
            //         let GLOBAL_CB ="foo";
            //         window[GLOBAL_CB] = function(res){
            //             resolve(res);
            //         }
                                                            
            //         url += /\?/.test(url) ? "&" : "?";
            //         let script = document.createElement("script");
            //         script.src = url + cb_fild + "=" +GLOBAL_CB;
            //         script.onload = function(){
            //             this.remove();
            //             resolve();
            //         }
            //         document.body.appendChild(script);
                                                                
            //     });          
            // }
            // jsonp("http://localhost/js/test/0711/jsontest.php","callback")
            // .then(function(res){
            //     console.log(res);
            // });
            
            //心情突然舒服 再来一遍
            
            function jsonp(url,cb_fild){
                return new Promise(function(resolve,reject){
                    let GLOBAL_CB = "foo";
                    window[GLOBAL_CB] = function(res){
                        //请求发送就是异步，请求发出去，接收到结果就是异步
                        resolve(res);
                    }

                    let script = document.createElement("script");
                    url += /\?/.test(url) ? "&" : "?";
                    script.src = url + cb_fild + "=" + GLOBAL_CB;
                    script.onload = function(){
                        this.remove();
                    }
                    document.body.appendChild(script);
                })

                
            }
           jsonp("http://localhost/js/test/0711/jsontest.php","callback").then( res => console.log(res) );
            //script src标签 浏览器会发送个一个请求，会调用服务器  
    </script>
    <!-- <script src="./jsontest.php"></script> -->
    <!-- <script src="http://localhost/js/test/0711/jsontest.php"></script> -->
</body>
</html>