<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ajax最终封装</title>
</head>
<body>

    <script>
        //总结一下
        //解构赋值{}={}形式 在函数形参内 是第一个{}内用等号设置默认值，第二个{}为空
        //ajax的基本封装思路
        //设置默认值 url {type，dataType，data，callback(主要是为了jsonp方便后台获取函数)}
        //首选判断下dataType，确定类型，如果是jsonp就去返回调用jsonp的函数;如果为text继续执行
        //然后 进行URl的拼接 以及ajax的四个步骤
        //在加载完成阶段需要在对dataType进行判断 为text类型就去调用JSON.stringify方法
        //如果为json类型就调用JSON.parse()方法
        //转换完结果之后在外边通过then方法进行执行就可以了

        //jsonp的封装思路
        //首先需要url data callback
        //同样的进行字符串的拼接 唯一注意一点就是在内部创建全局函数
        //拼接的过程中也需要注意拼接_Date.now()=callback
        //这次写的时候就发现了拼接函数之前没有加&符号导致出错
        //接下来就是创建script标签 通过src进行跨域访问 得到数据在全局函数内返回
            function ajax(
                url , 
                { 
                  type = "GET" ,
                  data = {} ,
                  dataType = "text",
                  callback = "callback"
                 } 
                =
                { })

                {   console.log(type)
                    if (dataType === "jsonp"){
                        return jsonp(url ,data , callback);
                    }
                    return new Promise(function( resolve,reject){

                        let datastr = "";
                        for(let attr in data){
                            datastr += (datastr.length > 0 ? "&" : "") + attr + "=" + data[attr];
                        }
                        console.log(datastr)
                        let xml = new XMLHttpRequest();
        
                     
                        type === "GET" ? url += (/\?/.test(url) ? "&" : "?") + datastr : "";
                        xml.open(type ? type : "GET",url);
                        type === "POST" ? xml.setRequestHeader("Content-type","application/x-www-form-urlencoded") : "";
                        xml.send(type === "POST" ? datastr : null);
        
                        xml.onreadystatechange = function(){
                            if(xml.readyState === 4 && xml.status === 200){
                                let res = xml.responseText;
                                switch(dataType){
                                        case "text" :res =  typeof res === "string" ? res : JSON.stringify(res);
                                            break;
                                        case "json" :res =  typeof res === "string" ? JSON.parse(res) : "";
                                            break;
                                }
                                resolve(res);
                            }
                        }
                        
                    })
                }    

            ajax(
            "http://localhost/js/test/0711/jsontest.php",

            {
                // type : "POST",
                data : {
                    "username" : "daweige",
                    "password" : "123456"
                },
                dataType : "jsonp"
            })
            .then(function(res){
                console.log(res);
            })


            function jsonp(url ,data ,file_cb){
                let GLOBAL_CB = "_" + Date.now();
                return new Promise(function(resolve , reject){
                    window[GLOBAL_CB] = function(res){
                        resolve(res);
                        delete window[GLOBAL_CB];
                        GLOBAL_CB = false;
                    }
                    let datastr = "";
                    for(let attr in data ){
                        datastr += (datastr.length > 0 ? "&" : "") + attr + "=" + data[attr];
                    }
                    url += /\?/.test(url) ? "&" : "?" + datastr+"&" + file_cb + "=" + GLOBAL_CB;
                    // console.log(url)
                    let script = document.createElement("script");

                    script.src = url ;

                    script.onload = function(){
                        this.remove();
                    }
                    document.body.appendChild(script);
                })
            }
            // jsonp("http://localhost/js/test/0712/json.php","callback")
            // .then(function(res){
            //     console.log(res);
            // })
    </script>
</body>
</html>