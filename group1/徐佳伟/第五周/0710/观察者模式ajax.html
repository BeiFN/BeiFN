<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>观察者模式下的ajax</title>
</head>
<body>
    <script>
        //总结一下
        //ajax的观察者模式封装不过如此
        //在ajax封装的基础上添加一个订阅者名单，也可以叫做list数组或对象
        //在ajax加载完成时，通过订阅者名单去告知其他函数，我加载完了，你们可以执行了、
        //最后return 返回一个add ，也就是订阅器，谁调用了ajax.add 就表明加入订阅者名单


        //这一套模式很快被其他方法取代
        //ajax的封装
            // function ajax(
            //     url,{                  
            //         type     = "GET",
            //         data     = {}
            //     }={}){
            //     //声明发布者名单
            //     var list = []; 

            //     var datastr = "";

            //     for(var attr in data){
            //         datastr += `${datastr.length > 0 ? "&" : ""}${attr}=${data[attr]}`
            //     }
            //     console.log(datastr);
            //     var xml = new XMLHttpRequest();

            //     xml.open(type,url+(type === "GET" ? (/\?/.test(url) ? "&" : "?") + datastr : ""));
            //     type === "POST" ? xml.setRequestHeader("Content-type","application/x-www-form-urlencoded") : "";
            //     xml.send(type === "POST" ? datastr : null);

            //     xml.onreadystatechange = function(){
            //         if( xml.readyState === 4 && xml.status === 200 ){
            //             //直接发布消息
            //             list.forEach( cb =>{
            //                 typeof cb === "function" ? cb(xml.responseText) : "";
            //             })
            //         }
            //     }

            //     return {
            //         add : function(callback){
            //             // list.push(callback);
            //             //漂亮啊兄弟
            //             list = list.concat(Array.from(arguments));
            //             console.log(list);
            //             return list;
            //         }
            //     }
            // }

            // ajax("http://localhost/js/0710/01ajax.txt",{             
            //     type : "POST",
            //     data : {
            //         "username" : "daweige",
            //         "password" : "123456"
            //     }
            // })
            // .add(function(res){
            //     console.log("函数1");
            //     console.log(res)
            // },function(res){
            //     console.log("函数2");
            //     console.log(res);
            // });
        
            //再来一遍墨紫紫

            function ajax(
                url,{
                    type = "GET",
                    data = {}
                } = {}){
                //订阅者名单
                let list = [];
                let datastr = "";

                for( let attr in data){
                    datastr += `${datastr.length > 0 ? "&" : ""}${attr}=${data[attr]}`;
                }
                console.log(datastr);
                
                let xml = new XMLHttpRequest();
                type === "GET" ? url += (/\?/.test(url) ? "&" : "?") +datastr : "";
                xml.open(type,url);
                type === "POST" ? xml.setRequestHeader("Content-type","application/x-www-form-urlencoded") : "";
                xml.send(type === "POST" ? datastr : null);

                xml.onreadystatechange = function(){
                    if(xml.readyState === 4 && xml.status === 200){
                        //执行完ajax之后，在执行list名单之中的信息
                        list.forEach(cb => {
                            cb(xml.responseText);
                        })
                    }
                }

                return {
                    //谁调用ajax 那么谁就在这个名单之中
                    //callback回调函数是指调用者的函数
                    // add : function(callback){
                        // list.push(callback);
                    // }
                        add : function(){
                            //这样可以同时多个回调函数订阅
                            list = list.concat(Array.from(arguments));
                        }                   
                }

            }

            ajax(
                "http://localhost/js/0710/02json.json",
                {
                    "type" : "POST",
                    "data" : {
                                "username" : "daweige",
                                "password" : "123456"
                            }
                })
                .add(callback);

                function callback(res){
                    console.log(res);
                }
    </script>
</body>
</html>