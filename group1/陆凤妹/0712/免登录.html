<!DOCTYPE html>
<html lang="en">

<head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <meta http-equiv="X-UA-Compatible" content="ie=edge">
       <title>免登录</title>
       <style>
              body {
                     background: rgba(0, 0, 0, .2);
              }

              #form {
                     width: 300px;
                     height: 300px;
                     border: 1px solid rgba(0, 0, 0, .3);
                     margin: 50px auto;
                     background: #ffffff;
              }

              div {
                     width: 250px;
                     height: 30px;
                     margin: 50px auto;
              }

              #pwd span {
                     margin-left: 10px;
              }

              input {
                     width: 170px;
                     height: 20px;
              }

              #btn {
                     display: block;
                     width: 100px;
                     height: 30px;
                     margin: 20px auto;
              }
       </style>
</head>

<body>
       <form id="form">
              <div><label id="usn">用户名：<input type="text" id="iptname" name="username" value=" lufengmei"></div>
              <div><label id="pwd">密 <span>码</span>：</label><input type="text" id="iptpassword" name=" password"
                            value="123456"></div>
              <button id="btn">提交</button>
       </form>


       <script src="libs/utils.js"></script>
       <script>
              function $(selector) {
                     var ele = null;
                     return (ele = document.querySelectorAll(selector)).length === 1 ? ele[0] : ele;
              }
              //       console.log($);
              //    引入工具库
              let {
                     ajax
              } = Utils;
              // 对form 、button解构赋值
              let [form, btn] = [
                     $("#form"),
                     $("#btn")
              ];
              //  from的事件监听   阻止默认事件发生
              form.addEventListener("submit", evt => {
                     let e = evt || window.event;
                     e.preventDeafult();

              })

              // button的事件监听
              btn.addEventListener("click", evt => {
                     // 解构赋值
                     let [iptNameValve, iptPasswordValue] = [
                            $("#iptname").value,
                            $("#iptpassword").value
                     ]


                     // 当执行完点击的动作后，将btn的状设置为 disabled  登录=>loading
                     btn.disabled = "disabled";
                     btn.innerHTML = "loading...";


                     //  获取url的数值
                     // 域名
                     let url = "http://localhost/coding/0712/login.php";
                     // 用户传入的值
                     let data = [
                            username = iptNameValve,
                            password = iptPasswordValue
                     ]

                     // 调用ajax函数
                     ajax(url, {
                                   data,
                                   type: "POST",
                                   dataType: "json"
                            })
                            .then(res => {
                                   //   stateCode 状态码 0 1 2 3 4
                                   switch (res.stateCode) {
                                          case 0:
                                                 alert("登陆参数不全");
                                                 break;
                                          case 2:
                                                 alert("数据库连接失败");
                                                 break;
                                          case 3:
                                                 alert("用户名不存在");
                                                 break;
                                          case 4:
                                                 alert("密码错误");
                                                 break;
                                          case 1:
                                                 alert("登陆成功");
                                                 location.reload();
                                                 break;
                                   }

                                   // 移除btn的disabled属性    loading => 登录
                                   btn.removeAttribute("disabled");
                                   btn.innerHTML = "登陆";

                                   console.log(res);
                            })
              })


              // 先发一个请求,验证是否存在tocken ,如果存在就不用登陆了;如果不存在我继续去登陆;



              function validateTocken() {
                     let url = "http://localhost/coding/0712/login.php";

                     ajax(url)
                            .then(res => {
                                   res = JSON.parse(res)
                                   if (res.state) {
                                          return false;
                                   }
                                   form.innerHTML = "用户名为:" + res.username + "<button id='exit'>退出登陆</button>";
                            })
              }

              validateTocken();
       </script>
</body>

</html>