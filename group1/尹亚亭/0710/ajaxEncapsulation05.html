<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ajax的Promise封装</title>
</head>
<body>
    <script>


        function ajax(url,type,data){
            // 返回函数变为状态机Promise，状态机的状态一旦发生改变，执行then()
            return new Promise(function(resolve,reject){


                // 兼容性问题
                var xhr = null;
                if (XMLHttpRequest) {
                    xhr = new XMLHttpRequest();
                }else{
                    xhr = new ActiveXObject("Microsoft.XMLHTTP");
                }
                if (xhr === null) {
                    throw "浏览器不支持ajax";
                }

                var data_str = "";
                // 判定是否为第一次拼接,第一次拼接不拼接"";
                for(var attr in data)
                {
                    data_str += `${data_str.length>0 ? "&" : ""}${attr} = ${data}${attr}`
                }
                // // 1.new  ==》 兼容性问题
                // var xhr = new XMLHttpRequest();
                // 2.open  **
                //xhr.open(type, url + (type === "GET" ? (/\?/.test(url) ? "&" : "?") + data_str : ""));
                // 稍微
                type === "GET" ? url += (/\?/.test(url) ? "&" : "?") + data_str: "";
                xhr.open( type? type:"GET",url);
                // //打印出get跳转的地址
                // console.log(url + (type === "GET" ? ( /\?/.test(url) ? "&" : "?" ) + data_str : "" ));
                // 2.5 setRequestHeader  **
               type === "POST" ? xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded"): "";
                // 3.send *
                xhr.send( type==="POST" ? data_str : null );
                // 4.onreadystatechange
                xhr.onreadystatechange=function(){
                    if (xhr.readyState===4 && xhr.status === 200) {
                        resolve(xhr.responseText);      // resolve 
                    }
                }


                // 设置超时
                setTimeout(function(){
                    reject(xhr,"timeout 8s !");
                },8000)
            })
        }


        // // 调用模式
        // ajax()
        // .then( function(res){
        //         console.log(res);
        // } ,function(error){
        //         console.log(error);     //
        // })


        //  Ajax的Promise封装
        ajax("http://localhost/yyt/0710/ajaxEncapsulation03.json",
                type = "GET",
                data = {
                    username  : "hello world",
                    passworld : "123456"
                }
        )
        .then( function(res){
                console.log(res);   //
        } ,function(error){
                console.log(error);
        })


        // Ajax的Promise封装
        ajax("http://localhost/yyt/0710/ajaxEncapsulation03.txt?data=1",
                type = "POST",
                data = {
                    username  : "hello world",
                    passworld : "123456"
                }
        )
        .then( function(res){
                console.log(res);   //
        } ,function(error){
                console.log(error);
        })


           
        // Ajax的Promise封装
        ajax(" http://localhost/yyt/0710/ajax01.txt",
                type = "POST",
                data = {
                    username  : "hello world",
                    passworld : "123456"
                }
        )
        .then( function(res){
                console.log(res);   //
        } ,function(error){
                console.log(error);
        })


    </script>
</body>
</html>