<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ajax的观察者模式的GET和POST封装</title>
</head>
<body>
    <script>
        // // 观察者模式改写简单的ajax的GET封装
        // function ajax(url){
        //     // 订阅者清单
        //     var list = [];
        //     // new
        //     var xhr = new XMLHttpRequest();
        //     // open
        //     xhr.open("GET",url);
        //     // send
        //     xhr.send(null);
        //     // onreadystatechange
        //     xhr.onreadystatechange = function () {
        //         if(xhr.readyState==4 && xhr.status == 200){
        //             console.log("执行结束");
        //             // 发布消息
        //             list.forEach( cb => {
        //                 typeof cb === "function" ? cb(xhr.responseText) : "";
        //             });
        //             // 等价于
        //             // for (var i = 0; i < list.length; i++) {
        //             //     list[i](xhr.responseText);
        //             // }
        //         }
        //     }

        //     return {
        //         add : function(){
        //             list = list.concat(Array.from(arguments));
        //             return list;
        //         },
        //     }

        // }

        // // 观察者模式改写简单的ajax封装  —— 使用
        // var url = "http://localhost/yyt/0710/ajaxEncapsulation03.json";
        // console.log(ajax(url).add(function(res){
        //     console.log(res);
        // },function(){   
        //     console.log("函数2")
        // }));


        // // 观察者模式改写简单的ajax的POST封装
        // function ajax(url,data){
        //     // 订阅者清单
        //     var list = [];
        //     var data_str = "";
        //     // 判定是否为第一次拼接,第一次拼接不拼接"";
        //     for(var attr in data)
        //     {
        //         data_str += `${data_str.length>0 ? "&" : ""}${attr} = ${data}${attr}`
        //     }
        //     // new
        //     var xhr = new XMLHttpRequest();
        //     // open
        //     xhr.open("POST",url);
        //     //  setRequestHeader
        //     xhr.setRequestHeader("Content-type" ,"application/x-www-form-urlencoded");
        //     // send
        //     xhr.send(data_str);
        //     // onreadystatechange
        //     xhr.onreadystatechange = function () {
        //         if(xhr.readyState==4 && xhr.status == 200){
        //             console.log("执行结束");
        //             // 发布消息
        //             list.forEach( cb => {
        //                 typeof cb === "function" ? cb(xhr.responseText) : "";
        //             });
        //             // 等价于
        //             // for (var i = 0; i < list.length; i++) {
        //             //     list[i](xhr.responseText);
        //             // }
        //         }
        //     }

        //     return {
        //         add : function(){
        //             list = list.concat(Array.from(arguments));
        //             return list;
        //         },
        //     }

        // }

        // // 观察者模式改写简单的ajax的POST封装  —— 使用
        // var url = "http://localhost/yyt/0710/ajaxEncapsulation03.json";
        // console.log(ajax(url).add(function(res){
        //     console.log(res);     // POST输出了数据结果
        // },function(){    
        //     console.log("函数2")
        // }));




        // 观察者模式改写简单的ajax的GET和POST合并版封装
        function ajax(url,
            {
            type = "POST",  //  type = "GET" ,
                data = {},   // post传递的数据
                contentType = "application/x-www-form-urlencoded" //post的setRequestHeader的参数值
            } = {}) 
        {
                // 订阅者名单
                var list = [];

                var data_str = "";
                // 判定是否为第一次拼接,第一次拼接不拼接"";
                for (var attr in data) {
                    data_str += `${data_str.length > 0 ? "&" : ""}${attr} = ${data}${attr}`;
                }
                // 1.new
                var xhr = new XMLHttpRequest();

                // 2.open  **
                xhr.open(type, url + (type === "GET" ? (/\?/.test(url) ? "&" : "?") + data_str : ""));

                // //打印出get跳转的地址
                // console.log(url + (type === "GET" ? ( /\?/.test(url) ? "&" : "?" ) + data_str : "" ));

                // 2.5 setRequestHeader  **
                type === "POST" ? xhr.setRequestHeader("Content-type", contentType) : "";

                // 3.send *
                xhr.send(type === "POST" ? data_str : null);
                // 4.onreadystatechange
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        console.log("执行结束");
                        //发布信息;
                        list.forEach(cb => {
                            typeof cb === "function" ? cb(xhr.responseText) : "";
                        })
                    }
                }

                return {
                    add: function () {
                        list = list.concat(Array.from(arguments));
                        return list;
                    }
                }
        }
    
        // // 观察者模式改写简单的ajax的GET和POST合并版封装,测试1
        // var res1= ajax("http://localhost/yyt/0710/ajaxEncapsulation03.json",{
        //         type : "GET",
        //         data : {
        //             username  : "hello world",
        //             passworld : "123456"
        //         }
        // }).add(function(res){
        //           console.log(res);
        // },function(){
        //         console.log("函数2")
        // });
        // console.log(res1);


        // // 观察者模式改写简单的ajax的GET和POST合并版封装,测试2
        // var res2= ajax("http://localhost/yyt/0710/ajaxEncapsulation02.php?data=1",{
        //         type : "POST",
        //         data : {
        //             username  : "hello world",
        //             passworld : "123456"
        //         }
        // }).add(function(res){
        //           console.log(res);
        // },function(){
        //         console.log("函数2")
        // });
        // console.log(res2);


        // 观察者模式改写简单的ajax的GET和POST合并版封装,测试3
        var res3= ajax("http://localhost/yyt/0710/ajax01.txt",{
                type : "POST",
                data : {
                    username  : "hello world",
                    passworld : "123456"
                }
        }).add(function(res){
                  console.log(res);
        },function(){
                console.log("函数2")
        });
        console.log(res3);


        //观察者模式改写简单的ajax的GET和POST合并版封装,测试4
        var res4= ajax("http://localhost/yyt/0710/ajaxEncapsulation03.json",{
                type : "POST",
                data : {
                    username  : "hello world",
                    passworld : "123456"
                }
        }).add(function(res){
                  console.log(res);
        },function(){
                console.log("函数2")
        });
        console.log(res4);

    </script>
   </body>
</html>