<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="referrer" content="no-referrer" />
		<title>lazyLoad</title>
		<style>
			*{
				margin: 0;
				padding: 0;
			}
			h1{
				text-align: center;
			}
			.container{
				width: 1000px;
				/* -- 行内样式 -- */
				line-height: 1.5;
				zoom: 1;
				overflow: hidden;
				/* visibility: hidden; */
				margin-left: auto;
				margin-right: auto;

			}

			.wrapper{
				height: auto;
				border-top: 0 none;
				background-color: #fff;
				border-radius: 2px;
				position: relative;
			}
			.box{
				border-bottom: 1px solid #e0e0e0;
				width: 235px;
				padding: 0;
				border-radius: 2px 2px 0 0;
				float: left;
				margin-left: 15px;
				box-sizing: border-box;
			}
			.box-img{
				height: 264px;
				/* 行内样式*/
				position: relative;
				min-height: 100px;
			}
			.box-img img{
				display: block;
				margin-left: auto;
				margin-right: auto;
				width: 100%;
				max-width: 235px;
			}
			.box-img u{
				height: 264px;
				/* 行内样式 */
				position: absolute;
				top: 0;
				left: 0;
				width: 235px;
				min-height: 100px;
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				box-sizing: border-box;
				margin-top: 0!important;
				border: 1px solid #e0e0e0;
			}
			.box-detail{
				padding: 14px 0;
				border-width: 0 1px 0 1px;
				border-style: solid;
				border-color: #e0e0e0;
			}
			.box-detail .title{
				padding: 0 14px;
				clear: both;
				overflow: hidden;
				margin: 0;
				font-size: 14px;
				color: #444;
				word-wrap: break-word;
				word-break: break-all;
			}

		</style>
	</head>
	<body>
		<div class="container">
			<div class="wrapper">
				
			</div>
		</div>
		
		<script src="../libs/utils.js"></script>
		<script type="text/javascript">
			let {ajax ,$ , on} = Utils;	
			class Render{
				constructor(arg) {
				    this.init();
				}
				async init(){
					this.wrapper = $(".wrapper");
					this.container = $(".container");
					this.height_array = [];
					this.children = [];
					this.loading = false;
					this.minHeight = 0;
					this.clientHei = document.documentElement.clientHeight;


					this.loading_img_url = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1563205824934&di=5478a6dfb0a5528bbe721b5ef89eafba&imgtype=0&src=http%3A%2F%2Fspider.nosdn.127.net%2F2964c767d5798be6c8f83739fb5689b9.gif";
					this.url = "http://localhost/dt",
					this.data = {
						include_fields:"top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
					    filter_id: "插画绘画",
					    start : 0,
						_ : Date.now()
					}
					this.res = await this.loadData();
					this.picLayout();
					// this.sort();
					this.getImgTop();
					this.setImg();

					
					this.timer = null;
					on(window,"scroll" , ()=>{
						clearInterval(this.timer);
						setTimeout( async ()=>{
							this.setImg();
							
						},300);
					})
				}

				async loadData(){
					this.data.start = this.next_start;
					let res = await ajax(this.url , {
						data : this.data,
						dataType : "json"
					});	
					this.next_start = res.data.next_start;
					return res;
				}
				picLayout(){
					let list = this.res.data.object_list;		
					let html = "";
					for(let i = 0; i< list.length ; i++){
						let scale_height = parseInt(list[i].photo.height / list[i].photo.width * 235);
						html += `<div class="box">
										<div class="box-img" style="height: ${scale_height}px" data-img="${list[i].photo.path}">
											  <img src="${this.loading_img_url}"  alt="">
											  <u style="height: ${scale_height}px"></u>
										</div>
										<div class="box-detail">
											  <div class="title">
													${list[i].msg}
											  </div>
										</div>
								  </div>`;
					}
					this.wrapper.innerHTML += html;
				}
				getImgTop(){
					this.children = this.wrapper.children ;
					
					Array.from(this.children).forEach( (box , index ) =>{
						let boxTop = box.offsetTop;
						box.setAttribute("data-top" , boxTop);
						if(boxTop >this.minHeight){
							this.minHeight = boxTop;
						}
					})
				}
				async setImg(){
					let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
					Array.from(this.children).forEach( (box , index ) =>{
						let imgTop = box.getAttribute("data-top");
						if(scrollTop >= imgTop- this.clientHei){
							let url = box.children[0].getAttribute("data-img");
							// console.log(box.children);
							box.children[0].children[0].src = url;
						}
						
					})
					if(!this.loading &&  scrollTop >= this.minHeight - this.clientHei){
						this.loading = true;
						this.res = await this.loadData();
						this.picLayout();
						this.getImgTop();
						this.loading = false;
					}
				}
				// sort(){
				// 	let children = this.wrapper.children ;
				// 	this.height_array = [];
				// 	// console.log(children);
				// 	Array.from(children).forEach( (box , index ) =>{
				// 		if(index <= this.count){
				// 			//判断是否是第一排
				// 			this.height_array.push(box.offsetHeight);
				// 			box.style.position = "static";
				// 		}else{
				// 			let min = Math.min.apply(false,this.height_array);
				// 			let minIndex = this.height_array.indexOf(min);
				// 			box.style.position = "absolute";
				// 			box.style.left = 250 * minIndex + "px";
				// 			box.style.top = min + 15 + "px";
				// 			this.height_array[minIndex] += + box.offsetHeight + 20 ;
				// 		}
				// 	})
				// 	this.container.style.height = Math.max.apply(false,this.height_array) + "px";
				// 	this.minHeight = Math.min.apply(false , this.height_array);
				// }
			


			
			}
			new Render();
		</script>
	</body>
</html>
