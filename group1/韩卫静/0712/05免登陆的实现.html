<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<form id="form">
            <p>用户名 : <input type="text" name="username" value="meishaonv"></p>
            <p>密  码 : <input type="text" name="password" value="11111"></p>
            <button id="btn">提交</button>
        </form>
      <div class="result"></div>
		<script type="text/javascript" src="utils.js">
			
		</script>
		<script type="text/javascript">
			//免登陆的实现逻辑
			//获取ajax方法
			let {ajax , $ , removeCookie} = Utils;
			let [btn,form,result] =[ $("#btn") , $("#form") , $(".result")];
			//取消表单的默认提交事件,添加按钮的提交时间
			form.onsubmit = function(evt){
				var e = evt || window.event;
				e.preventDefault ? e.preventDefault() : e.returnValue = false;
			}
			btn.onclick = function(){
				//优化
				btn.disabled = "disabled";
				btn.innerHTML = "loading..."
				
				// 获取表单的值,存入data中
				var nameValue = $("input[name=username]").value;
				var pwdValue = $("input[name=password]").value;
				// console.log(nameValue,pwdValue);
				
				let url = "http://localhost/hwj/0712/login.php";
				data = {
					username : nameValue,
					password : pwdValue
				}
				// 发出ajax请求,将值传入后端
				ajax(url,{
					type:"POST",
					dataType:"json",
					data:data
				}).then(function(res){
					// 获取后端返回的结果,并对结果做出处理
					/**
					 *  stateCode :   0 缺少参数;
									  1 表示登陆成功;
									  2 数据库连接失败;
									  3 用户名不存在;
									  4 密码错误;
					 */
					// console.log(res);
					switch(res.stateCode){
						case 0 : alert("缺少参数");break;
						case 2 : alert("数据库连接失败");break;
						case 3 : alert("用户名不存在");break;
						case 4 : alert("密码错误");break;
						case 1 : alert("登录成功");break;
					}
					
					//优化
					btn.removeAttribute("disabled");
					btn.innerHTML = "登录"
					verification();
				})
			}
			//先发送一个请求,验证是否存在tocken,如果存在就不用登录了,不存在才会显示登录界面
			function verification(){
				let url = "http://localhost/hwj/0712/login.php";
				ajax(url).then(function(res){
					res = JSON.parse(res);
					console.log(res);
					if(res.state === "error"){
						return false;
					}
					form.style.display = "none";
					result.innerHTML = "用户"+ res.username + "已登录";
					result.innerHTML += "<button id='exit'>退出登录</button>"
				})
			}
			verification();
			
			result.addEventListener("click",function(evt){
				var e = evt || window.event;
				var target = e.srcElement || e.target;
				if(target.nodeName === "BUTTON"){
					result.innerHTML = "";
					form.style.display = "block";
					
					removeCookie("TOCKEN");
				}
			})
			
		</script>
	</body>
</html>
