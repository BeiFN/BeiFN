<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <meta name="referrer" content="no-referrer">
      <title>Document</title>
</head>
<body>
      <div class="container">
            <img src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=909624486,4182680343&fm=26&gp=0.jpg" style="width:300px; height:300px">
      </div>
      <script src="./utils.js"></script>
      <script>
            let{ajax,ejs,$, on} = Utils;
            class LazyLoad{
                  constructor(){
                        this.init();
                  }
                  async init(){
                        this.timer = null;
                        on(window , "scroll" , ()=>{
                              if(this.timer != null)  return false;
                              this.timer = setTimeout ( ()=>{
                                    this.rerender();
                                    this.timer = null;
                              },500)    
                        })

                        this.res = await this.getData();
                        this.render(this.res.data.object_list);
                        this.getAllDiv();
                        this.rerender();
                  }
                  render(data){
                        let str = "";
                        for(let i = 0, item; item = data[i++]; ){
                              str += `<div class="box" data = "${item.photo.path}" oftop = "${300/item.photo.width*item.photo.height}">
                                                <img src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=909624486,4182680343&fm=26&gp=0.jpg" style = "width:${300}px; height:${300/item.photo.width*item.photo.height}px">
                                      </div>`
                        }
                        document.body.innerHTML = str;
                  }
                  //获取到所有的div
                  getAllDiv(){
                        this.divs = Array.from(document.body.children);
                  }
                  rerender(){
                        this.divs.forEach((item)=>{
                              let h = document.documentElement.scrollTop + document.documentElement.clientHeight;
                              if(item.getAttribute("oftop") <h){
                                    item.children[0].src = item.getAttribute("data");
                              }
                        })
                  }
                  async getData(){
                        let url = "http://localhost/dt";
                        let data = {
                              include_fields:"top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                              filter_id: "手工DIY",
                              start : this.start
                        };
                        return ajax(url, {
                              data:data,
                              dataType:"json"
                        })
                  }
            }
            new LazyLoad();
      </script>
</body>
</html>