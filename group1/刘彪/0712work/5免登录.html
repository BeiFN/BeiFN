<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <form action="" id="form">
        <p>用户名: <input type="text" name="username"></p>
        <p>密&nbsp;&nbsp;&nbsp;码: <input type="text" name="password"></p>
        <button id="btn">点击登录</button>
    </form>

    <script src="../libs/utils.js"></script>
    <script>
        let {ajax,$} = Utils;
        let[form,btn] = [$("#form"),$("#btn")];
        form.addEventListener("submit" , evt =>{
            let e = evt || window.event;
            e.preventDefault();
        })
        btn.addEventListener("click",evt=>{
            let[
                userValue,
                pwdVale,
            ]=[
                $("input[name=username").value,
                $("input[name=password").value,
            ]
            let url = "http://localhost/0712/login.php";
            let data = {
                username : userValue,
                password : pwdVale,
            }

            //禁用按钮;
            btn.disables = "disabled";
            btn.innerHTML = "loading";

            ajax(url,{
                data,
                type:"POST",
                dataType: "json",
            }).then(res=>{
               console.log(res.stateCode);
               switch(res.stateCode){
                   case 0 : alert("登录参数不全");
                            break;
                   case 2 : alert ("数据库链接失败");
                            break;
                   case 3 : alert("用户名不存在");
                           break;
                   case 4 : alert("密码错误");
                            break;
                   case 1 : alert("登录成功");
                   location.reload();
                            break;
               }
               btn.removeAttribute("disabled");
               btn.innerHTML = "登录";
               console.log(res);
            })
        })
        //先发一个请求,验证是否存在tocken,如果存在就不用登录了,如果不存在,继续登录;
        function validateTocken(){
            let url = "http://localhost/0712/login.php";
            ajax(url)
            .then(res=>{
               console.log(res);
               res = JSON.parse(res);
                if(res.state){
                    return false;
                }
                form.innerHTML = "用户名:" +res.username+ "<button id = 'exit'> 退出登录</button>";
            })
        }
        validateTocken();
    </script>
</body>
</html>