<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>烟花</title>
    <style>
        body{
            background: #000;
        }
        .moon{
            width:  40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 0 10px 10px #eee;
            background-color: #fff;
            position: absolute;
            right: 50px;
            top: 20px;
        }
        #container{
            width:  320px;
            height: 540px;
            background: #000;
            border: 2px solid #103020;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
        }

        .firework{
            width:  4px;
            height:  6px;
            border-radius: 1px 1px 2px 2px;
            box-shadow: 0 0 1px 1px #eee;
            background: #fff;
            position: absolute;
        }
        .firework1{
            width:  6px;
            height:  6px;
            border-radius: 50%;
            position: absolute;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="moon"></div>
        <!-- <div class="firework"></div> -->
    </div>
    <script>
        // 1.创建随机颜色div功能
        // 2.上升功能
        // 3.爆炸功能

        

        function Firework(selector){
            this.main = document.querySelector(selector);
            console.log(this.main);
            if(this.main ===null)return false;
            this.init();
        };

        Firework.prototype.init = function(){
            console.log(11);

            // this.main.addEventListener("click",this.createFirework.bind(this));
            this.main.addEventListener("click",this.clickNightSky.bind(this));
        };
        Firework.prototype.clickNightSky = function(evt){
            var e = evt || window.event;
            var offsetX = e.offsetX;
            var offsetY = e.offsetY;

            var fire = this.fireInit(offsetX);
            this.fireworkMove(fire,offsetY,this.fireworkBoom.bind(this,offsetX,offsetY,e));
        }
        //烟花上升
        Firework.prototype.fireworkMove = function(fire,offsetY,boomCallBack){
            move(fire,{top:offsetY},function(){
                fire.remove();
                boomCallBack();
            });
        }
        // 烟花爆炸
        Firework.prototype.fireworkBoom = function(offsetX,offsetY,evt){
            // var randomFireCount = 15 + Math.round(Math.random() * 10);
            var e = evt || window.event;

            console.log(e.offsetX,e.offsetY,320-offsetX,540-offsetY);
            var randomFireCount = Math.min.apply(Math,[e.offsetX,e.offsetY,320-offsetX,540-offsetY]);
            console.log(randomFireCount);

            var blank = Math.round(360 / randomFireCount);
            var r = 100 + Math.round(Math.random() * 100);
            var angle = 0;

            for(var i = 0 ; i < randomFireCount ; i++){
                  angle += blank;

                  var fire_targetX = Math.round(Math.cos( Math.PI / 180 * angle ) * r + offsetX); 
                  var fire_targetY = Math.round(Math.sin( Math.PI / 180 * angle ) * r + offsetY); 

                  var fire_boom = this.createFirework(true);
                  fire_boom.style.left = offsetX + "px";
                  fire_boom.style.top  = offsetY + "px";
                  this.main.appendChild(fire_boom);

                  move(fire_boom , {
                        left : fire_targetX ,
                        top  : fire_targetY ,
                        opacity : 0
                  },function(fire_boom){
                        fire_boom.remove();
                  }.bind(false,fire_boom))
            }
        }


        //烟花初始化
        Firework.prototype.fireInit = function(offsetX){
            var fire = this.createFirework();
            fire.style.left = offsetX +"px";
            fire.style.bottom = 0;
            this.main.appendChild(fire);
            return fire;
        }
        // 创建烟花
        Firework.prototype.createFirework = function( isColor){
        
            // 创建元素
            var fire = document.createElement("div");
            // 运算
            fire.className = "firework1";
            if(isColor){
                fire.style.background = getRandomColor();
            }else{
                fire.style.background = "#fff";
                fire.className = "firework";
            }
            
            

            // 放入页面
            // this.main.appendChild(fire);
            // 创建的烟花返回出去
            return fire;
        };
        function getRandomColor(){
           

            var  r = Math.round(Math.random()*255);
            var  g = Math.round(Math.random()*255);
            var  b = Math.round(Math.random()*255);
            return "rgb("+r+","+g+","+b+")";
        }

        new Firework("#container");
        // new Firework(".xxx");

        // 运动框架
        function move(dom, json, callBack){
            clearInterval(dom.timer);
            dom.timer = setInterval(function(){
                for(var attr in json){
                    // console.log(attr,json[attr]);
                    //获取目标元素dom当前属性值
                    var iNow = parseInt( getComputedStyle(dom)[attr]);
                    if(attr === "opacity"){
                        iNow = parseInt( getComputedStyle(dom)[attr]*100);
                    }
                    // console.log(iNow);
                    //计算速度
                    var speed = (json[attr]-iNow)/10;
                    //速度取整除去小数
                    speed = speed > 0 ? Math.ceil(speed):Math.floor(speed);
                    if(json[attr] === iNow){
                        delete json[attr];
                        if(Object.keys(json).length === 0){
                            clearInterval(dom.timer);
                            typeof callBack === "function" ? callBack():"";
                        }
                    }else{
                        if(attr === "opacity"){
                            dom.style[attr] = (iNow + speed)/100;
                        }else{
                            dom.style[attr] = iNow + speed + "px";
                        }
                    }
                }
            },50);
        };
    </script>
</body>
</html>