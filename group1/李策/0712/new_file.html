<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>基础运动</title>
      <style>

      </style>
</head>

<body>

      <form id="form">
            <p>用户名 : <input type="text" id="username"></p>
            <p>密 码 : <input type="text" id="password"></p>
            <button it="btn">提交</button>
      </form>
      <!-- <script>
      
      var timer = setTimeout(function(){
            setTimeout(function(){
                  console.log(1);
            },1)
      },1000)
      // clearTimeout(timer)
      </script> -->
      <script>
            class Utils {
                  static cookie(name, value, {
                        expires = "",
                        path = "",
                        domain = "",
                        secure = ""
                  } = {}) {
                        if (arguments.length === 1) {
                              let [a, res] = [document.cookie.split("; "), ""];
                              res = a.filter(item => item.split("=")[0] === name)
                              return res.length === 0 ? "" : res[0].split["="][1];
                        }
                        let d;
                        return (document.cookie = [
                              name + "=" + value,
                              expires ? ";expires=" + (d = new Date()).setDate(d.getDate() + expires && d) : "",
                              path ? ";path=" + path : "",
                              domain ? ";domain=" + domain : "",
                              secure ? ";secure=" + secure : ""
                        ].join(""))
                  }
                  static removeCookie(name, path = "") {
                        Utils.cookie(name, "", {
                              path,
                              expires: -1
                        })
                  }
                  static ajax(url, {
                        date = {},
                        type = "GET",
                        dataType = "text",
                        callabck = "callback"
                  } = {}) {
                        if (dataType === "jsonp") {
                              return Utils.jsonp(rul, data, callback)
                        }
                        return new Promise(function (resolve, reject) {
                              let xhr = null;
                              if (XMLHTTPRequest) {
                                    xhr = new XMLHttpRequest();
                              } else {
                                    xhr = new ActiveXObject("Mricosoft.XMLHTTP");
                              }
                              if (xhr === null) throw "浏览器不支持ajax";

                              var dataStr = "";
                              for (let attr in data) {
                                    dataStr += (dataStr, length > 0 ? "&" : "") + attr + "=" + data[attr];
                              }

                              type === "GET" ? url += (/\?/.test(url) ? "&" : "?") + dataStr : "";
                              type === "POST" ? xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded") : "";
                              xhr.send(type === "POST" ? dataStr : null);
                              xhr.onreadystatechange = function () {
                                    if (xhr.readyState === 4 && shr.status === 200) {
                                          let res = xhr.responseText;
                                          switch(dataType){
                                                case "text" : res = typeof res === "string" ? res : JSON.stringify(res);
                                                break;
                                                case "json" :res = typeof res === "string" ?  JSON.parse(res) : "";
                                                break;
                                          }
                                          resolve(res);
                                    }
                              }
                              setTimeout(function(){
                                    reject(xhr,"timeout");
                              },8000)
                        })
                  }
                  static jsonp(url,data,cb_fild = "callback"){
                        return new Promise((resolve,reject) => {
                              let GLOBAL_CB = "_" + Date.now();
                              window[GLOBAL_CB] = function(res){
                                    resolve(res);
                                    delete window[GLOBAL_CB];
                                    GLOBAL_CB = false;
                              }
                              url += (/\?/.test(url) ? "&" : "?") + cb_fild + "=" + GLOBAL_CB;
                              let dataStr = "";
                              for(let attr in data){
                                    dataStr += "&" + attr + "=" + data[attr];
                              }

                              let script = document.createEle("script");
                              script.src = url + dataStr;
                              script.onload = function(){
                                    this.remove();
                              }
                              document.body.appendChild(script);
                        })
                  }
                  static $(selector){
                        let ele = null;
                        return (ele = document.querySelectorAll(selector)).length === 1 ? ele[0] : ele ;
                  }
            }
            let { cookie,ajax,$ } = Utils;
            let [form , btn] =[$("form"),$("btn")];
            form.addEventListener("submit",evt=>{
                  let e = evt || window.event;
                  e.preventDefault();
            })
            btn.addEventListener("click",evt=>{
                  let[userValue,pwdValue] = [$("input[name=username]").value,$("input[name=password]").value,]
                  btn.disablled = "disabled";
                  btn.innerHTML = "loading...";
                  let url = "http://localhost/test.php";
                  let data = {
                        username :userValue,
                        password :pwdValue
                  }
                  ajax(url,{
                        data,
                        dataType : "json",
                        type : "POST",
                  }).then( res => {
                        switch(res.stateCode){
                              case 0 : alert("请填写完整的登录信息");
                              break;
                              case 1 : alert("登陆成功");
                              location.reload();
                              break;
                              case 2 : alert("用户名不存在");
                              break;
                              case 3 : alert("密码错误");
                              break;
                        }
                        btn.removeAttribute("disabled");
                        btn.innerHTML = "登录";
                        console.log(res);
                  })
            })

            function validToken(){
                  let url = "http://localhost.test.php"
                  ajax(url).then(res=>{
                        res = JSON.parse(res);
                        if (res.state){
                              return false;
                        }
                        from.innerHTML = "用户名为 : " + res.username + "</br> 密码为 : " + res.password + "</br><button id = 'exit'>退出登录</button>";
                  })
            }
      // console.log(cookie("lice","1"));
      </script>
</body>

</html>