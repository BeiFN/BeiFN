<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <form id="form">
    <p>用户名 : <input type="text" name="username" value="xxp"></p>
    <p>密  码 : <input type="text" name="password" value="123"></p>
    <button id="btn">登陆</button>
  </form>
  <script src="../libs/utils.js"></script>
  <script>
    let{ajax, $} = Utils;
    let[form, btn] = [
      $("#form"),
      $("#btn")
    ];
    // 阻止提交按钮的刷新页面功能
    form.addEventListener("submit", evt =>{
      let e = evt || window.event;
      e.preventDefault();
    })
    // 点击事件
    btn.addEventListener("click", evt =>{
      // 获取输入的用户名和密码
      let [
        usrValue,
        pwdValue
      ] = [
        $("input[name=username]").value,
        $("input[name=password]").value,
      ]
      // console.log(usrValue,pwdValue);
      // 禁用按钮
      btn.disabled = "disabled";
      btn.innerHTML = "loading...";
      // 获取ajax需要的数据
      let url = "http://localhost/myCode/0712/login.php";
      let data = {
        username : usrValue,
        password : pwdValue
      }
      // 进行ajax跨域，判断登陆结果，输出
      ajax(url, {
        data,
        type : "POST",
        dataType : "json"
      })
      .then(res => {
        switch(res.stateCode){
          case 0 :
            alert("登陆参数不全");
            break;
          case 2 : 
            alert("数据库连接失败");
            break;
          case 3 : 
            alert("用户名不存在");
            break;
          case 4 : 
            alert("密码错误");
            break;
          case 1 : 
            alert("登陆成功");
            location.reload();
            break;
        }
        btn.removeAttribute("disabled");
        btn.innerHTML = "登陆";
        console.log(res)
      })
    })
    // 先发一个请求,验证是否存在tocken ,如果存在就不用登陆了;如果不存在我继续去登陆;
    function validateTocken(){
      let url = "http://localhost/myCode/0712/login.php";
      ajax(url)
      .then(res => {
        res = JSON.parse(res);
        if(res.state){
          return false;
        }
        // console.log(res);
        form.innerHTML = "用户名为：" + res.username + "<button id='exit'>退出登陆</button>";
      })
    }
    validateTocken();
  </script>
</body>
</html>