<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        #container{
            width: 600px;
            height: 400px;
            background: #000;
            border: 2px solid #f10;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            margin: auto;
        }
        .firework{
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #fff;
            position: absolute;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script src="./common.js"></script>
    <script>
    class Firework{
        constructor(selector){
            console.log(this);
            let{$} = Utils;
            this.main = $(selector);
            if(this.main === null){
                return false;
            }
            this.init();
        }
        // 初始化
        init(){
            this.main.addEventListener("click", this.handleFirework.bind(this));
        }
        // 处理烟花
        handleFirework(evt){
            let e = evt || window.event;
            let offsetX = e.offsetX;
            let offsetY = e.offsetY;
            let firework = this.initFirework(offsetX);
            this.fireworkMove(firework,offsetY,this.fireworkBlast.bind(this,offsetX,offsetY));
        }
        // 烟花爆炸
        fireworkBlast(offsetX,offsetY){
            let randomFireCount = 20 + Math.round(Math.random() * 10);
            let distance = parseInt(360 / randomFireCount);
            let r = 50 + Math.round(Math.random() * 50);
            let angle = 0;
            for(let i = 0; i < randomFireCount; i++){
                angle += distance;
                let fireTargetX = Math.round(Math.cos(Math.PI / 180 * angle) * r + offsetX);
                let fireTargetY = Math.round(Math.sin(Math.PI / 180 * angle) * r + offsetY);
                let subFirework = this.createFirework();
                subFirework.style.left = offsetX + "px";
                subFirework.style.top = offsetY + "px";
                this.main.appendChild(subFirework);
                Utils.move(subFirework, {
                    left : fireTargetX,
                    top : fireTargetY,
                    opacity : 0
                },function(subFirework){
                    subFirework.remove();
                }.bind(null,subFirework))
            }
        }
        // 烟花运动
        fireworkMove(firework,offsetY,blastCallback){
            Utils.move(firework, {
                top : offsetY
            },function(){
                firework.remove();
                blastCallback();
            })
        }
        // 初始化烟花
        initFirework(offsetX){
            let firework = this.createFirework();
            firework.style.left = offsetX + "px";
            firework.style.bottom = 0;
            this.main.appendChild(firework);
            return firework;
        }
        // 生成烟花
        createFirework(){
            let firework = document.createElement("div");
            firework.className = "firework";
            firework.style.background = Utils.randomColor();
            return firework;
        }
    }

    new Firework("#container");
    </script>
</body>
</html>