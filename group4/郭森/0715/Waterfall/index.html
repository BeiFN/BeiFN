<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="./styles/index.css">
</head>

<body>
    <h1>瀑布流</h1>
    <div class="container">
        <div class="wrapper">
            <!-- <div class="box">
                        <div class="box-img">
                              <img src="https://c-ssl.duitang.com/uploads/item/201905/23/20190523154247_ggxrq.thumb.400_0.jpg" alt="">
                              <u></u>
                        </div>
                        <div class="box-detail">
                              <div class="title">
                                    橡皮章
                              </div>
                        </div>
                  </div> -->
        </div>
    </div>

    <script type="text/html" id="template">
        <% for(var i in data){ %>
            <div class="box" data-width="<%= data[i].photo.width %>" data-height="<%= data[i].photo.height %>  ">
                    <div class="box-img" style="height:<%= parseInt(data[i].photo.height/data[i].photo.width*235) %>px">
                          <img src="<%= data[i].photo.path %>" alt="">
                          <u style="height:<%= parseInt(data[i].photo.height/data[i].photo.width*235) %>px"></u>
                    </div>
                    <div class="box-detail">
                          <div class="title">
                                <%= data[i].msg %>
                          </div>
                    </div>
              </div>
        <% } %>
    </script>
    <script src="../../../ku/hanshuku.js"></script>
    <script src="../../../ku/ejs/ejs.js"></script>
    <!-- <script src="./javascript/index.js"></script> -->
    <script src="./Waterfall.js"></script>
    <script>
        // 绑定事件 排列页面
        // 加载数据
        // 渲染页面
        // 排列
        class LoadRender {
            constructor() {
                this.init();
                this.bindEvent();
                this.load();
            }
            init() {
                this.box = $$(".wrapper");
                this.bigBox = $$(".container");
                this.domHeight = document.documentElement.clientHeight;
                this.waterfall = new Waterfall(".wrapper", {
                    fixedWidth: 235,
                    marginLeft: 15,
                    marginBottom: 20,
                });
                this.start = 0;
                this.boxHeight = 0;
                this.bigBox.style.width = document.documentElement.clientWidth + "px";
            }
            bindEvent() {
                let timer1, timer2;
                // 滚动条事件，加载数据
                on(window, "scroll", evt => {
                    if (timer1) return false;
                    timer1 = setTimeout(a => {
                        let scrtop = document.documentElement.scrollTop || document.body.scrollTop;
                        if (scrtop > this.boxHeight - this.domHeight - 300) {
                            this.load();
                        }
                        timer1 = null;
                    }, 200)
                })
                // 页面缩放
                on(window, "resize", () => {
                    clearInterval(timer2);
                    timer2 = setTimeout(() => {
                        this.bigBox.style.width = document.documentElement.clientWidth + "px";
                        this.waterfall.init();
                        this.boxHeight = this.box.clientHeight;
                    }, 200)
                })
            }
            // 加载数据
            async load() {
                let [url, data] = [
                    "http://localhost/dt",
                    {
                        include_fields: "top_comments,is_root,source_link,item,buyable,root_id,status,like_count,sender,album,reply_count",
                        filter_id: "美食菜谱",
                        start: this.start
                    }
                ];
                let res = await ajax(url, { data: data, dataType: "json" });
                this.start = res.data.next_start;
                this.render(res.data.object_list);
            }
            // 渲染页面
            render(list) {
                this.box.innerHTML += ejs.render(template.innerHTML, { data: list });
                this.waterfall.sort();
                this.boxHeight = this.box.clientHeight;
            }
        }
        new LoadRender();


    </script>
</body>

</html>